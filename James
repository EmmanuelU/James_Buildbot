#!/bin/bash

# parse options - credit aokp for idea
clear
if [ -f james-build-log.txt ]
  then
    echo "Previous log exists, deleting..."
    	rm james-build-log.txt
clear
fi
if [ -f James~ ]
  then
    	rm James~
clear
fi
command=
ver=3.2.1
# BEGIN Configure to your own needs

# This should in your global bin folder and should echo your password
# example contents of getjamespass file
# 
# echo yourpasswordhere
pass=$(getjamespass)
#
#
admin=xmcwildchild22
rom=JellyKang
romver=1.0
upload=
buildtype=Debug
uploadurl=
host=upload.goo.im
url=ftp://$admin:$pass@$host/public_html/Roms/
nightly_path=Kang/Nightlies/"$rom"_Nightly_$outdate.zip
stable_path=Kang/"$rom"_v$romver.zip
TARGET_PRODUCT=cm_doubleshot
DEVICE=doubleshot
COMPANY=htc
# END
clean=
j=j5
outdate=$(date +%m%d%y)
date=$(date)
os=$(uname)
user=$(whoami)
java=$(type java)
echo James v$ver was started --BEGIN LOG >>james-build-log.txt
echo  >>james-build-log.txt
while getopts ":c :-h :-s :u :n :r :q" opt
do
    case "$opt" in
        c) clean=true
	   command=1
	   echo clean=true >>james-build-log.txt
        ;;

        s) sync=true
	   command=1
	   echo sync=true >>james-build-log.txt
        ;;

        u) upload=true
        echo upload=true >>james-build-log.txt
        command=1
        ;;

        q) shutdown=true
        echo shutdown=true >>james-build-log.txt
        command=1
        ;;

        h) echo ===-- James Builder v$ver --===
        echo
	echo Usage: ./James -[OPTIONS]
	echo        
	echo  
	echo Options: 
	echo            
	echo [-h] - Show this message
	echo	
	echo [-s] - Sync the repo before building
	echo
	echo [-c] - Clean the enviroment before building
	echo
	echo [-q] - Shutdown Computer after Build
	echo
	echo
	echo Upload build to FTP Server:
	echo	
	echo [-un] - Upload a Nightly
	echo	
	echo [-ur] - Upload a Stable Release
	echo
	exit 1	
        ;;

        \?)
	     echo "Usage: ./James -[OPTIONS] or use ./James -h for help"
	     echo
             echo "invalid option: -$OPTARG"
             exit 1
        ;;

        n)
	if [ ! "$upload" = "true" ] ; then
	echo "You are not uploading so no need for -n or -r"
	exit 1
	fi
	if [ "$buildtype" = "Stable" ] ; then
	echo You cannot use -n and -r together.
	echo "invalid option: -$OPTARG"
	exit 1
	fi    
	command=1
	buildtype=Nightly
	echo buildtype=$buildtype >>james-build-log.txt 
	uploadurl=$url$nightly_path
        ;;

        r)
	if [ ! "$upload" = "true" ] ; then
	echo "You are not uploading so no need for -n or -r"
	exit 1
	fi
	if [ "$buildtype" = "Nightly" ] ; then
	echo You cannot use -n and -r together.
	exit 1
	fi    
	command=1
	buildtype=Stable 
	echo buildtype=$buildtype >>james-build-log.txt 
	uploadurl=$url$stable_path
        ;;
    esac
done
if [ "$buildtype" = "" ] 
	then 
	if [ "$upload" = "true" ]
	then
		echo "You must specify a buildtype"
		echo "Use [-n] for Nightly or [-r] for Stable release"
		exit -1
	fi
fi
clear
echo Running Start-up checks.
sleep 1
echo
if [ ! -d "device/$COMPANY/$DEVICE" ]
  then
    echo "No $rom build device directory found!"
    	sleep 2
		echo exiting...
			sleep 1
				exit
fi
if [ -d "device/$COMPANY/$DEVICE" ]
  then
    echo "$rom build device directory found!"
    	sleep 2
fi
clear
echo Running Start-up checks..
echo >>app.sh
## Will add download scripts for missing files later
echo command -v java >/dev/null 2>&1 || { echo >&2 "Java is not installed"; sleep 2; exit 1;} >>app.sh
echo command -v repo >/dev/null 2>&1 || { echo >&2 "Repo binary is not installed"; sleep 2; exit 1;} >>app.sh
echo command -v ccache >/dev/null 2>&1 || { echo >&2 "Ccache binary is not installed"; sleep 2; exit 1;} >>app.sh
echo command -v make >/dev/null 2>&1 || { echo >&2 "Make is not installed"; sleep 2; exit 1;} >>app.sh
echo command -v mka >/dev/null 2>&1 || { echo >&2 "Make is not installed"; sleep 2; exit 1;} >>app.sh
echo command -v wget >/dev/null 2>&1 || { echo >&2 "wget is not installed"; sleep 2; exit 1;} >>app.sh
echo command -v wput >/dev/null 2>&1 || { echo >&2 "wput is not installed"; sleep 2; exit 1;} >>app.sh
chmod +x app.sh
./app.sh
rm app.sh
echo 
echo All required packages are installed | tee -a james-build-log.txt
echo  >>james-build-log.txt
sleep 2
clear
echo Running Start-up checks...
sleep 1
cd out/target/product/$DEVICE
if [ -f $TARGET_PRODUCT-ota-eng.$user.zip ]
  then
    echo Deleting old rom ...
    rm -rf $TARGET_PRODUCT-ota-eng.$user.zip
fi
sleep 1
echo 
echo You are on $os
echo $java
java -version
sleep 3
clear
sleep 2
clear
echo Passed startup checks! >>james-build-log.txt
echo  >>james-build-log.txt
echo ===James-Builder-v$ver===
echo 
echo Hello, my name is James! Nice to meet you $user
echo ==========================
echo It is $date
echo
if [ "$sync" = "true" ]
	then 
	echo Syncing...  
	repo sync -$j
fi  
echo Type: $buildtype
echo =========
echo Setting up build enviroment...
sleep 2
echo 
echo >>james-build-log.txt
echo 
export USE_CCACHE=1 | tee -a james-build-log.txt
echo >>james-build-log.txt
prebuilt/linux-x86/ccache/ccache -M 100G | tee -a james-build-log.txt
prebuilts/misc/linux-x86/ccache/ccache -M 100G | tee -a james-build-log.txt
echo >>james-build-log.txt
echo 
clear
echo >>james-build-log.txt
echo "$buildtype for $TARGET_PRODUCT"
echo =========
sleep 2
if [ "$clean" = "true" ]
	then 
	echo Cleaning...  
	make clobber -$j
fi  
echo =========
echo
clear
echo "Building $buildtype for $TARGET_PRODUCT ..."
echo "Building for $TARGET_PRODUCT on $TARGET_BUILD_VARIANT at $date" >>james-build-log.txt
echo >>james-build-log.txt
if [ -f build.sh ]
  then
    rm build.sh
fi
echo echo Locating trees... >>build.sh
echo sleep 2 >>build.sh 
echo . build/envsetup.sh >>build.sh
echo echo >>build.sh
echo echo Found trees >>build.sh
echo echo >>build.sh
echo "echo Lunching for $TARGET_PRODUCT" >>build.sh
echo lunch $TARGET_PRODUCT-userdebug >>build.sh
echo echo >>build.sh
echo echo Compiling... >>build.sh
echo mka bacon >>build.sh
chmod +x build.sh
./build.sh | tee -a james-build-log.txt
echo >>james-build-log.txt
rm build.sh
echo
sleep 2
cd out/target/product/$DEVICE
if [ ! -f $TARGET_PRODUCT-ota-eng.$user.zip ]
  then
    echo There was an error building ...
    exit 1
fi
if [ "$upload" = "true" ] 
	then
	echo Hello $user, uploading $buildtype to $uploadurl
	echo -----------------------------------------------
	echo
	wput -v $TARGET_PRODUCT-ota-eng.$user.zip "$uploadurl"
	echo 
	echo Uploaded
fi
if [ "$shutdown" = "true" ] 
	then
	echo Shutting Down ...
	echo $pass | sudo shutdown -S -h now
	
fi
echo
echo I am done with session, enjoy ":)" -James
exit 1
